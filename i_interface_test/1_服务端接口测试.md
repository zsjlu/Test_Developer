# 服务端接口测试

接口测试价值与体系

如果把简单测试分为两类，那么就是客户端测试和服务端测试。
客户端的测试包括UI测试，兼容性测试等，服务端测试包括接口测试。
接口测试检查数据的交换，传递和控制管理过程，它绕过了
客户端，直接对服务端进行测试。

接口测试的价值

服务端非常复杂，组件与组件之间进行交互，形成了密集的后端
网络。UI测试无法覆盖这么复杂的组件交互网络，所以要绕过
客户端，直接只用接口测试对服务端进行测试。

接口测试的体系

分层测试

    UI--Service--Unit
    
客户端测试与服务端测试的关系

虽然接口测试覆盖广，但是也不能使用接口测试替代客户端测试。
UI测试测试涉及到了用户体验的问题，这部分是无法用接口测试
进行替代的。

    tcp/udp/http/restful/dubbo等协议区别于解读


## 抓包分析tcp协议

TCP协议是在传输层中，一种面向连接的、可靠的、基于字节流的
传输层通信协议。

环境准备

对接口测试工具进行分类，可以分如下几类：

- 网络嗅探工具：tcpdump， wireshark    
- 代理工具：fddler，charles，anyproxyburpsuite，mitmproxy   
- 分析工具： curl，postman，chrome Devtool

## 抓包分析tcp协议

### tcpdump

tcpdump：将网络中传送的数据包的“头”完全截获下来提供分析。
它支持针对网络层、协议、主机、网络或端口的过滤，并提供
and、or、not等逻辑语句来帮助你去掉无用的信息。

让tcpdump时刻监听443端口，如果有异样就输入到log文件中

    sudo tcpdump port 443 -v -w /tmp/tcp.log
    # -v 输出更加纤细的信息
    # -w 把数据写到log中
        
利用这条命令，会把得到的报告放到目录/tmp/tcp.log中。

### wireshark

wireshark也是一款网络嗅探工具，它除了拥有tcpdump功能，还有更多扩展
功能，比如分析工具，但是在接口测试中，抓包过程往往都是在服务器进行，
服务器一般不提供ui界面，所以wireshark无法在服务器工作，只能利用tcpdump
抓包生成log，然后将log分给wireshark，在youui界面的客户端上进行分析。
另外，如果数据包使用的是https协议，wireshark是无法抓取的。

抓包分析tcp协议

__三次握手__

- 第一次握手：建立连接时，客户端发送syn包（syn=j）到服务器，并进入
SYN_SENT状态，等待服务器确认。

- 第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1),同时
自己也发送一个SYN包（seq=k），即SYN+ACK包，此时服务器进入SYN_REC
状态；

- 第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK
（ack=k+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）
状态，完成三次握手。

__四次挥手__

- 第一次挥手：客户端向服务器端发送一个FIN，请求关闭数据传输

- 第二次挥手：服务器接收到客户端的FIN，向客户端发送一个ACK，其中
ack的值等于FIN+SEQ

- 第三次挥手：服务器向客户端发送一个FIN，告诉客户端应用程序关闭。

- 第四次挥手：客户端收到服务器端的FIN，回复一个ACK给服务器端。其中
ack的值等于FIN+SEQ

注意：一个请求可能分为多个包，一个数据也是这样，于是在wireshark会看到
很多包。

## 使用postman发送请求

略

## 使用curl发送请求

CURL是一个通过URL传输数据的，功能强大的命令行工具。CURL可以与Chrom
Devtool工具配合使用，把浏览器发送的真实请求还原出来，附带认证信息，
脱离浏览器执行，方便开发者重放请求、修改参数调试，编写脚本。也可以
单独使用，根据自己的需求构造请求调整参数，构造多种接口测试场景。

>ChromeDevTools

    F12

在Network面板中可以查看通过网络来请求来的资源的详细信息：

>curl常见用法

从浏览器copy

1.右键左侧数据，选择Copy->copy as curl，即可把请求内容转化为curl命令。

2.将命令copy在gitbash或bash上并运行，查看返回信息

3.对上面命令进行细化，加入-v参数可以打印更详细的内容，用2>&1将标准
错误重定向到标准输出，发送此命令将得到细化后的内容

>其他常用命令

发起get请求

    curl "https://httpbin.testing-studio.com/get" -H "accept:application/json"
    
发送post请求

    curl -X POST "https://httpbin.testing-studio.com/post" -H "accept:acpplication/json"

proxy的使用

    curl -x 'http://127.0.0.1:8000' $url
    
curl重要参数

|参数|含义|
|---|---|
|-H|消息头设置|
|-u|用户认证|            
|-d|表示来自于文件|            
|-data-urlencode|对内容进行url编码|            
|-G|把data数据当成get|            
|-o|写文件|            
|-x|http代理、socks5代理|            
|-v|打印更详细日志|            
|-s|关闭一些提供输出|            
|-help|查看帮助|

>curl实战演练

1.篡改请求头信息，将User-Agent改为“testing-studio”

    curl -H "User-Agent:testing-studio" "http://www.baidu.com" -v
    
2.在企业微信中通过curl命令创建标签，这是一个post请求，通过--data参数
传递tagname和tagid
    
    curl -H "Content-Type: application/json" -X POST\
    --data '{"tagname": "hogwarts", "tagid": 13}'\
    https://qyapi.weixin.qq.com/cgi-bin/tag/create?access_token=$token
    
3.认证，通过put上传到ElasticSearch，使用-user进行用户认证

    curl -X PUT "$ES_HOST/$index/_doc?$id?pretty"\
    --user username:password \
    -H 'Content-Type: application/json'\
    -d "$content"                    

    



## 常用代理工具
        